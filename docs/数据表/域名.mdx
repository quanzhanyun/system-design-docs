# CDN Domain（CDN域名）

| Name         | Type             | Relation With | Description                        |
|--------------|------------------|---------------|------------------------------------|
| domain       | Text(short text) |               |                                    |
| config       | JSON             |               |                                    |
| cname        | Text(short text) |               | 我们自己分配的 cname，为 null 时用 upCname 字段 |
| upCname      | Text(short text) |               | 上游厂商分配的 cname                      |
| upstream     | Enumeration      |               | [上游接入商](../厂商名称.mdx)               |
| domainStatus | Enumeration      |               | active（正常使用）\| starting(启动中) \| stopping(停止中) \| configuring(配置中)  \| deleting(删除中) \| deleted(已删除) \| blocked（管理员设为禁用） |
| user         | Relation         | User          |                                    |
| certificate         | Relation(多对一)         | Certificate |                                    |

## domainStatus 状态说明

首先，域名的状态分为 `上游状态` 和 `本地状态`。

`上游状态` 反映的是域名在上游厂商处的底层状态，对应 `config` 中的 [`DomainStatus`](https://docs.ksyun.com/documents/196#3) 属性；`本地状态` 是我们自己对域名的管理，对应 `domainStatus` 字段。

### active 状态

正常状态（穿透状态）。处于此状态时，前端页面展示域名状态时需要获取 `config` 中的 `DomainStatus` 属性并展示，本质是展示上游的底层状态。

比如，用户要停止域名时，调用上游接口停止域名即可。

### starting 状态

由于上游对域名的停止、启用 只分配了完成态标记（online、offline），对域名处于“启用中”和“停用中”状态无法表示，因此在本地状态中增加了 starting 和 stopping 状态，用于标记状态的过渡。

当用户将上游处于 offline 状态的域名启用时 ，域名的本地状态处于 starting 状态，等启动成功后，本地状态改为 active 状态。


### stopping 状态

当用户将上游处于 online 状态的域名停用时 ，域名的本地状态处于 stopping 状态，等停用操作成功后，本地状态改为 active 状态。

### configuring 状态

虽然上游有此状态，但是向上游提交配置并等待上游更新状态有时间差，考虑到向用户反馈的效率，我们自己设一个 configuring 字段。
每次修改配置时将本地状态设置为 configuring，配置完成后将状态改为 active


### deleting 状态

删除域名流程如下：

1. 用户必须手动停止域名。也就是说域名必须是“停止”状态才能删除
2. 将域名设置为 deleting 状态
3. 调用上游接口删除域名

注意：域名标记为 deleting 时，不允许任何用户添加与此域名相同的域名，考虑到上游的统计延迟，我们需要等待一段时间才能让用户再次添加该域名，否则会导致计费混乱

注意：我们在本地数据库中并不会真正删除域名的信息和计费日志，而是在等待一段时间完成计费收尾后，将域名设置为 `deleted` 状态（TODO：考虑将 `deleted` 域名迁移到其它的表中作为历史记录存储）。

注意：为域名标记 deleted 状态的工作由后台程序定期执行。


重要的是完成计费！！！

### deleted 状态

用户的域名已被删除，这有两层意思：一是用户的域名在上游已经被删除了，并且等待了一段时间完成了计费收尾；二是用户的域名在本地数据库中仍然存在，只是不再展示给用户看、也不会再继续计费。（TODO：考虑将 `deleted` 域名迁移到其它的表中作为历史记录存储）

注意：为域名标记 deleted 状态的工作由后台程序定期执行。


### blocked 状态

由管理员主动将用户的域名禁用。这一操作需要将用户的域名设置为 `blocked` 状态并调用上游接口停止域名。